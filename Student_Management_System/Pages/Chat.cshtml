@page
@model Student_Management_System.Pages.ChatModel
@{
    ViewData["Title"] = "Chat Room";
    Layout = null;
}

<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <title>@ViewData["Title"] - Teams Chat</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    
    <!-- Teams Theme CSS -->
    <link rel="stylesheet" href="~/css/teams-theme.css" asp-append-version="true" />
    
    <!-- Prevent FOUC -->
    <script>
        (function() {
            const theme = localStorage.getItem('teams-app-theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>
<body class="chat-page">
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content teams-modal">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-circle me-2" style="color: var(--teams-brand-primary);"></i>
                        Enter Your Username
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="teams-input-group">
                        <input type="text" id="usernameInput" class="teams-input" placeholder="Your display name" autofocus>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="teams-btn teams-btn-primary" id="enterChatBtn">
                        <i class="bi bi-box-arrow-in-right"></i>
                        Enter Chat
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="teams-image-modal" onclick="closeImageModal()">
        <span class="close"><i class="bi bi-x-lg"></i></span>
        <img id="modalImage" src="">
    </div>

    <!-- Context Menu - Enhanced with more options -->
    <div id="contextMenu" class="context-menu" style="display: none;">
        <div class="context-menu-item" onclick="copyMessage()" title="Copy message text">
            <i class="bi bi-clipboard-check"></i>
            <span>Copy</span>
        </div>
        <div class="context-menu-item context-menu-recall" onclick="recallMessage()" style="display: none;" title="Recall this message">
            <i class="bi bi-arrow-counterclockwise"></i>
            <span>Recall</span>
        </div>
        <hr style="margin: 4px 0; border: none; border-top: 1px solid var(--teams-border-primary);">
        <div class="context-menu-item" onclick="selectMessage()" title="Select message">
            <i class="bi bi-cursor-text"></i>
            <span>Select</span>
        </div>
    </div>


    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <style>
        /* Context Menu - Enhanced */
        .context-menu {
            position: fixed;
            background: var(--teams-surface-elevated, var(--teams-surface-primary));
            border: 1px solid var(--teams-border-primary);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            padding: 6px 0;
            min-width: 180px;
            z-index: 10000;
            animation: slideUp 0.15s ease;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: var(--teams-text-primary);
            transition: all 0.15s;
            white-space: nowrap;
        }

        .context-menu-item:hover {
            background: var(--teams-bg-hover);
            padding-left: 18px;
        }

        .context-menu-item i {
            font-size: 16px;
            color: var(--teams-brand-primary);
            width: 18px;
            text-align: center;
        }
            color: var(--teams-text-secondary);
        }

        .context-menu-item.danger {
            color: var(--teams-status-error);
        }

        .context-menu-item.danger i {
            color: var(--teams-status-error);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            background: var(--teams-surface-elevated, #333);
            color: white;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: toastSlideIn 0.3s ease;
            pointer-events: auto;
        }

        .toast.success { background: #107C10; }
        .toast.error { background: #D13438; }
        .toast.warning { background: #FFB900; color: #000; }
        .toast.info { background: var(--teams-brand-primary); }

        .toast.hiding {
            animation: toastSlideOut 0.3s ease forwards;
        }

        @@keyframes toastSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @@keyframes toastSlideOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Typing Indicator */
        .typing-indicator {
            padding: 8px 20px;
            background: var(--teams-surface-primary);
            border-top: 1px solid var(--teams-border-primary);
            animation: fadeIn 0.2s ease;
        }

        .typing-indicator-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .typing-dots {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--teams-brand-primary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0s;
        }

        @@keyframes typingBounce {
            0%, 80%, 100% {
                transform: scale(0.6);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .typing-text {
            font-size: 13px;
            color: var(--teams-text-secondary);
            font-style: italic;
        }

        /* Recalled message style */
        .teams-message-group.recalled {
            opacity: 0.7;
        }

        .teams-message-bubble.recalled-message {
            background: var(--teams-bg-hover) !important;
            color: var(--teams-text-tertiary) !important;
            font-style: italic;
            border: 1px dashed var(--teams-border-primary);
        }

        .teams-message-bubble.recalled-message i {
            margin-right: 6px;
        }

        /* Recalled file/image specific styles */
        .teams-message-group.recalled .teams-file-attachment {
            opacity: 0.6;
            cursor: default !important;
            pointer-events: none;
        }

        .teams-message-group.recalled .teams-image-preview {
            filter: blur(8px) brightness(0.7);
            cursor: default !important;
            pointer-events: none;
        }

        /* Room Info Popup */
        .room-info-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .room-info-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
        }

        .room-info-content {
            position: relative;
            background: var(--teams-surface-primary);
            border-radius: 12px;
            padding: 24px;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            text-align: center;
            animation: slideUp 0.3s ease;
        }

        .room-info-content h3 {
            margin: 0 0 16px;
            color: var(--teams-text-primary);
            font-size: 20px;
        }

        .room-info-content p {
            margin: 8px 0;
            color: var(--teams-text-secondary);
            font-size: 14px;
        }

        .room-info-hint {
            margin-top: 16px !important;
            padding: 10px;
            background: var(--teams-bg-hover);
            border-radius: 6px;
            color: var(--teams-brand-primary) !important;
            font-size: 13px !important;
        }

        .room-info-content button {
            margin-top: 20px;
            padding: 10px 24px;
            background: var(--teams-brand-primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .room-info-content button:hover {
            background: var(--teams-brand-hover);
        }

        /* Delete Confirmation Modal */
        .delete-confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10002;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .delete-confirmation-modal.show {
            display: flex;
        }

        .delete-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
        }

        .delete-modal-content {
            position: relative;
            background: var(--teams-surface-primary);
            border-radius: 12px;
            padding: 24px;
            min-width: 400px;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @@keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @@keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .delete-modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .delete-modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(209, 52, 56, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--teams-status-error);
            font-size: 24px;
        }

        .delete-modal-title {
            flex: 1;
        }

        .delete-modal-title h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--teams-text-primary);
        }

        .delete-modal-body {
            margin-bottom: 24px;
        }

        .delete-modal-body p {
            margin: 0 0 12px;
            color: var(--teams-text-secondary);
            line-height: 1.5;
        }

        .delete-modal-warning {
            padding: 12px;
            background: rgba(209, 52, 56, 0.1);
            border-left: 3px solid var(--teams-status-error);
            border-radius: 4px;
            margin-top: 12px;
        }

        .delete-modal-warning p {
            margin: 0;
            font-size: 13px;
            color: var(--teams-status-error);
            font-weight: 500;
        }

        .delete-modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .delete-modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .delete-modal-btn-cancel {
            background: var(--teams-bg-hover);
            color: var(--teams-text-primary);
        }

        .delete-modal-btn-cancel:hover {
            background: var(--teams-bg-active);
        }

        .delete-modal-btn-delete {
            background: var(--teams-status-error);
            color: white;
        }

        .delete-modal-btn-delete:hover {
            background: #B71C1C;
        }

        .delete-modal-btn-delete:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmationModal" class="delete-confirmation-modal">
        <div class="delete-modal-overlay" onclick="closeDeleteModal()"></div>
        <div class="delete-modal-content">
            <div class="delete-modal-header">
                <div class="delete-modal-icon">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                </div>
                <div class="delete-modal-title">
                    <h3>Delete Room?</h3>
                </div>
            </div>
            <div class="delete-modal-body">
                <p>Are you sure you want to delete <strong id="deleteRoomNameDisplay"></strong>?</p>
                <p>This action cannot be undone.</p>
                <div class="delete-modal-warning">
                    <p><i class="bi bi-info-circle me-1"></i> All messages and files will be permanently deleted, and all users will be removed from the room.</p>
                </div>
            </div>
            <div class="delete-modal-footer">
                <button class="delete-modal-btn delete-modal-btn-cancel" onclick="closeDeleteModal()">
                    Cancel
                </button>
                <button class="delete-modal-btn delete-modal-btn-delete" id="confirmDeleteBtn" onclick="confirmDeleteRoom()">
                    <i class="bi bi-trash me-1"></i> Delete Room
                </button>
            </div>
        </div>
    </div>

    <!-- Leave Room Confirmation Modal -->
    <div id="leaveConfirmationModal" class="delete-confirmation-modal">
        <div class="delete-modal-overlay" onclick="closeLeaveModal()"></div>
        <div class="delete-modal-content">
            <div class="delete-modal-header">
                <div class="delete-modal-icon" style="background: rgba(0, 120, 212, 0.1); color: var(--teams-brand-primary);">
                    <i class="bi bi-box-arrow-right"></i>
                </div>
                <div class="delete-modal-title">
                    <h3>Leave Room?</h3>
                </div>
            </div>
            <div class="delete-modal-body">
                <p>Are you sure you want to leave <strong id="leaveRoomNameDisplay"></strong>?</p>
                <p style="color: var(--teams-text-tertiary); font-size: 13px;">You can rejoin this room later using the Room ID.</p>
            </div>
            <div class="delete-modal-footer">
                <button class="delete-modal-btn delete-modal-btn-cancel" onclick="closeLeaveModal()">
                    Cancel
                </button>
                <button class="delete-modal-btn" id="confirmLeaveBtn" onclick="confirmLeaveRoom()" style="background: var(--teams-brand-primary); color: white;">
                    <i class="bi bi-box-arrow-right me-1"></i> Leave Room
                </button>
            </div>
        </div>
    </div>

    <!-- Username Already Exists Modal -->
    <div id="usernameExistsModal" class="delete-confirmation-modal">
        <div class="delete-modal-overlay" onclick="closeUsernameExistsModal()"></div>
        <div class="delete-modal-content">
            <div class="delete-modal-header">
                <div class="delete-modal-icon" style="background: rgba(255, 185, 0, 0.1); color: #FFB900;">
                    <i class="bi bi-person-exclamation"></i>
                </div>
                <div class="delete-modal-title">
                    <h3>Username Already Taken</h3>
                </div>
            </div>
            <div class="delete-modal-body">
                <p>The username <strong id="duplicateUsernameDisplay"></strong> is already being used in this room.</p>
                <p style="color: var(--teams-text-tertiary); font-size: 13px;">Please choose a different username to join.</p>
                <div style="margin-top: 16px;">
                    <input type="text" id="newUsernameInput" class="teams-input" placeholder="Enter a new username" style="width: 100%;">
                </div>
            </div>
            <div class="delete-modal-footer">
                <button class="delete-modal-btn delete-modal-btn-cancel" onclick="closeUsernameExistsModal()">
                    Cancel
                </button>
                <button class="delete-modal-btn" id="retryJoinBtn" onclick="retryJoinWithNewUsername()" style="background: var(--teams-brand-primary); color: white;">
                    <i class="bi bi-person-check me-1"></i> Join with New Name
                </button>
            </div>
        </div>
    </div>

    <!-- Teams-like Layout -->
    <div class="teams-container">
        <!-- Left Navigation (Simplified) -->
        <div class="teams-left-nav">
            <div class="teams-nav-item active" title="Chat">
                <i class="bi bi-chat-dots-fill"></i>
                <span>Chat</span>
            </div>
            <div class="teams-nav-item" title="Back to Rooms" onclick="leaveRoom()">
                <i class="bi bi-arrow-left"></i>
                <span>Back</span>
            </div>
            <div class="teams-nav-item" style="margin-top: auto; margin-bottom: 8px;" id="themeToggle" title="Toggle Theme">
                <i class="bi bi-moon-fill" id="themeIcon"></i>
                <span>Theme</span>
            </div>
        </div>

        <!-- Chat List Panel -->
        <div class="teams-chat-list-panel">
            <div class="teams-chat-list-header">
                <h5>Chat</h5>
                <div class="teams-header-actions">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()" title="Toggle sidebar">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
            </div>

            <div class="teams-chat-list">
                <div class="teams-chat-section">
                    <div class="teams-section-header">Current Room</div>
                    <div id="roomsList">
                        <div class="teams-chat-item active">
                            <div class="teams-avatar" id="roomAvatar" style="background: var(--teams-brand-primary);">
                                <span id="roomAvatarInitial">R</span>
                                <span class="teams-status-indicator"></span>
                            </div>
                            <div class="teams-chat-info">
                                <div class="teams-chat-name" id="currentRoomName">Loading...</div>
                                <div class="teams-chat-preview" id="roomUserCount">0 users online</div>
                                <div class="teams-chat-preview" style="font-size: 10px; opacity: 0.7;">
                                    <i class="bi bi-hash"></i><span id="currentRoomId">@Model.RoomId</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Main Chat Area -->
        <div class="teams-chat-main">
            <!-- Chat Header -->
            <div class="teams-chat-header">
                <div class="teams-chat-header-left">
                    <button class="mobile-back-btn teams-icon-btn" onclick="toggleSidebar()" title="Show sidebar">
                        <i class="bi bi-list"></i>
                    </button>
                    <div class="teams-avatar" style="background: var(--teams-brand-primary);">
                        <span id="headerAvatarInitial">R</span>
                        <span class="teams-status-indicator"></span>
                    </div>
                    <div class="teams-chat-header-info">
                        <h5 id="headerRoomName">Loading...</h5>
                        <small id="headerRoomId" style="color: var(--teams-text-tertiary); font-size: 12px;">
                            <i class="bi bi-hash"></i>@Model.RoomId
                        </small>
                    </div>
                </div>
                <div class="teams-chat-header-actions">
                    <button class="teams-icon-btn" onclick="showRoomInfo()" title="Room info">
                        <i class="bi bi-info-circle"></i>
                    </button>
                    <button class="teams-icon-btn d-none" id="deleteRoomBtn" onclick="deleteRoom()" title="Delete room" style="color: var(--teams-status-error);">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="teams-icon-btn" onclick="leaveRoom()" title="Leave room">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="teams-messages-container" id="messagesContainer">
                <!-- Messages will be loaded here -->
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="typing-indicator" style="display: none;">
                <div class="typing-indicator-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span class="typing-text" id="typingText">Someone is typing...</span>
                </div>
            </div>

            <!-- Message Input -->
            <div class="teams-message-input-container">
                <div class="teams-message-input-wrapper">
                    <textarea id="messageInput" class="teams-message-input" placeholder="Type a message..." rows="1"></textarea>

                    <div class="teams-input-actions-right">
                        <input type="file" id="fileInput" class="d-none" onchange="handleFileSelect(event)">
                        <button class="teams-input-btn" onclick="document.getElementById('fileInput').click()" title="Attach file">
                            <i class="bi bi-paperclip"></i>
                        </button>
                        <button class="teams-input-btn" id="emojiBtn" onclick="toggleEmojiPicker()" title="Add emoji">
                            <i class="bi bi-emoji-smile"></i>
                        </button>
                        <button class="teams-input-btn teams-send-btn" id="sendBtn" onclick="sendMessage()" title="Send message">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>

                    <!-- Emoji Picker -->
                    <div id="emojiPicker" class="teams-emoji-picker">
                        <div class="teams-emoji-content" id="emojiContent">
                            <div class="teams-emoji-section">
                                <div class="teams-emoji-section-title">Smileys</div>
                                <div class="teams-emoji-grid" id="emojiGrid">
                                    <!-- Emojis will be loaded by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Progress -->
    <div id="uploadProgress" class="teams-upload-progress">
        <div class="teams-upload-header">
            <span class="teams-upload-title">
                <i class="bi bi-cloud-upload me-2"></i>Uploading
            </span>
            <button class="teams-icon-btn" onclick="cancelUpload()" style="padding: 4px;">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div id="uploadFileName" class="teams-upload-info" style="margin-bottom: 8px;"></div>
        <div class="teams-progress-bar-container">
            <div id="progressBar" class="teams-progress-bar-fill" style="width: 0%"></div>
        </div>
        <div id="uploadStatus" class="teams-upload-info"></div>
    </div>

    <!-- Scripts -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="~/js/teams-helpers.js" asp-append-version="true"></script>
    
    <script>
        const roomId = '@Model.RoomId';
        let username = '@Model.Username';
        let connection = null;

        // Typing indicator state
        let typingUsers = new Set();
        let typingTimeout = null;
        let isTyping = false;

        // Emoji list
        const emojis = [
            '\u{1F44D}', '\u{2764}\u{FE0F}', '\u{1F60A}', '\u{1F602}', '\u{1F389}', '\u{1F525}', '\u{1F4AF}', '\u{2705}',
            '\u{1F600}', '\u{1F603}', '\u{1F604}', '\u{1F601}', '\u{1F606}', '\u{1F605}', '\u{1F923}', '\u{1F607}',
            '\u{1F642}', '\u{1F609}', '\u{1F60D}', '\u{1F970}', '\u{1F618}', '\u{1F60B}', '\u{1F60E}', '\u{1F929}',
            '\u{1F973}', '\u{1F60F}', '\u{1F914}', '\u{1F917}', '\u{1F644}', '\u{1F634}', '\u{1F62D}', '\u{1F621}',
            '\u{1F44B}', '\u{1F44C}', '\u{270C}\u{FE0F}', '\u{1F91E}', '\u{1F44A}', '\u{1F64F}', '\u{1F4AA}', '\u{1F44F}',
            '\u{1F4BB}', '\u{1F4F1}', '\u{1F4F7}', '\u{1F4A1}', '\u{1F4DA}', '\u{1F4DD}', '\u{1F4C5}', '\u{1F512}',
            '\u{1F9E1}', '\u{1F49B}', '\u{1F49A}', '\u{1F499}', '\u{1F49C}', '\u{2728}', '\u{2B50}', '\u{1F31F}'
        ];

        // Chunk size for file upload (5MB)
        const CHUNK_SIZE = 5 * 1024 * 1024;

        document.addEventListener('DOMContentLoaded', function() {
            // Load emojis
            loadEmojis();
            
            // Initialize theme
            updateThemeIcon();
            
            // Set room initial
            const roomInitial = roomId.charAt(0).toUpperCase();
            document.getElementById('roomAvatarInitial').textContent = roomInitial;
            document.getElementById('headerAvatarInitial').textContent = roomInitial;
            
            if (!username) {
                const modal = new bootstrap.Modal(document.getElementById('loginModal'));
                modal.show();
                
                document.getElementById('enterChatBtn').addEventListener('click', enterChat);
                document.getElementById('usernameInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') enterChat();
                });
            } else {
                initializeChat();
            }

            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Typing indicator - detect when user is typing
            document.getElementById('messageInput').addEventListener('input', handleTyping);

            // Close emoji picker and context menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#emojiPicker') && !e.target.closest('#emojiBtn')) {
                    document.getElementById('emojiPicker').classList.remove('show');
                }
                hideContextMenu();
            });

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', function() {
                TeamsTheme.cycle();
                updateThemeIcon();
            });

            // New username input enter key
            document.getElementById('newUsernameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') retryJoinWithNewUsername();
            });

            // Clear error style on input
            document.getElementById('newUsernameInput').addEventListener('input', function() {
                this.style.borderColor = '';
            });
        });

        // Context menu variables
        let selectedMessageId = null;
        let selectedMessageSender = null;
        let selectedMessageContent = null;


        function loadEmojis() {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = emojis.map(emoji => 
                `<span class="teams-emoji-item" onclick="insertEmoji('${emoji}')">${emoji}</span>`
            ).join('');
        }

        function updateThemeIcon() {
            const theme = TeamsTheme.getTheme();
            const icon = document.getElementById('themeIcon');
            if (theme === 'dark') {
                icon.className = 'bi bi-sun-fill';
            } else {
                icon.className = 'bi bi-moon-fill';
            }
        }

        function enterChat() {
            const input = document.getElementById('usernameInput');
            username = input.value.trim();
            if (!username) {
                input.style.borderColor = 'var(--teams-status-error)';
                return;
            }
            
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            initializeChat();
        }

        let roomName = '';
        let roomCreatedBy = '';

        async function initializeChat() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chathub")
                .withAutomaticReconnect()
                .build();

            connection.on("ReceiveMessage", function(message) {
                addMessage(message);
            });

            connection.on("UserJoined", function(user, room) {
                addSystemMessage(`${user} joined the room`);
                // Request updated user list
                if (connection) {
                    connection.invoke("GetRoomUsersAsync", roomId).then(users => {
                        if (users) updateUsersList(users);
                    }).catch(() => {});
                }
            });

            connection.on("UserLeft", function(user, room) {
                addSystemMessage(`${user} left the room`);
                // Remove from typing users if they were typing
                typingUsers.delete(user);
                updateTypingIndicator();
                // Request updated user list
                if (connection) {
                    connection.invoke("GetRoomUsersAsync", roomId).then(users => {
                        if (users) updateUsersList(users);
                    }).catch(() => {});
                }
            });

            // Typing indicator handlers
            connection.on("UserStartedTyping", function(user) {
                typingUsers.add(user);
                updateTypingIndicator();
            });

            connection.on("UserStoppedTyping", function(user) {
                typingUsers.delete(user);
                updateTypingIndicator();
            });


            connection.on("RoomDeleted", function(room) {
                showToast('This room has been deleted by the owner', 'error');
                setTimeout(() => window.location.href = '/', 2000);
            });

            connection.on("UsernameExists", function(existingUsername, room) {
                document.getElementById('duplicateUsernameDisplay').textContent = existingUsername;
                document.getElementById('newUsernameInput').value = '';
                document.getElementById('usernameExistsModal').classList.add('show');
            });

            connection.on("RoomJoined", function(room, name, createdBy, users) {
                roomName = name;
                roomCreatedBy = createdBy;
                updateRoomInfo(name, createdBy);
                updateUsersList(users);
            });

            connection.on("LoadMessages", function(messages) {
                messages.forEach(msg => addMessage(msg));
                scrollToBottom();
            });

            connection.on("FileUploadProgress", function(sender, fileName, progress) {
                if (sender !== username) {
                    console.log(`${sender} is uploading ${fileName}: ${progress}%`);
                }
            });

            connection.on("MessageRecalled", function(messageId, sender, messageType) {
                const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageEl) {
                    messageEl.classList.add('recalled');
                    const bubble = messageEl.querySelector('.teams-message-bubble');
                    if (bubble) {
                        bubble.classList.add('recalled-message');
                        
                        // Different message based on type
                        let recallText = '';
                        if (messageType === 'Image') {
                            recallText = '<i class="bi bi-image"></i> <em>Image has been recalled</em>';
                        } else if (messageType === 'File') {
                            recallText = '<i class="bi bi-file-earmark"></i> <em>File has been recalled</em>';
                        } else {
                            recallText = '<i class="bi bi-ban"></i> <em>Message has been recalled</em>';
                        }
                        
                        bubble.innerHTML = recallText;
                    }
                    
                    // Also update file attachments
                    const fileAttachment = messageEl.querySelector('.teams-file-attachment');
                    if (fileAttachment) {
                        fileAttachment.onclick = null;
                        fileAttachment.style.cursor = 'default';
                        fileAttachment.style.opacity = '0.6';
                    }
                    
                    const imagePreview = messageEl.querySelector('.teams-image-preview');
                    if (imagePreview) {
                        imagePreview.onclick = null;
                        imagePreview.style.cursor = 'default';
                        imagePreview.style.filter = 'blur(8px) brightness(0.7)';
                    }
                }
                if (sender !== username) {
                    const typeText = messageType === 'Image' ? 'an image' : 
                                   messageType === 'File' ? 'a file' : 'a message';
                    showToast(`${sender} recalled ${typeText}`, 'info');
                }
            });

            connection.onreconnecting(() => {
                addSystemMessage('Reconnecting...');
            });

            connection.onreconnected(() => {
                addSystemMessage('Reconnected');
                connection.invoke("JoinRoom", roomId, username);
            });

            try {
                await connection.start();
                addSystemMessage('Connected to chat');
                await connection.invoke("JoinRoom", roomId, username);
            } catch (err) {
                console.error('Connection error:', err);
                addSystemMessage('Connection failed. Please refresh the page.');
            }
        }

        function addMessage(message) {
            const container = document.getElementById('messagesContainer');
            const isOwn = message.sender === username;
            const avatarColor = TeamsUI.getAvatarColor(message.sender);
            const avatarInitial = message.sender.charAt(0).toUpperCase();
            
            // Debug log
            if (message.type === 'Image' || message.type === 'File') {
                console.log('File message received:', {
                    type: message.type,
                    fileId: message.fileId,
                    fileName: message.fileName,
                    isRecalled: message.isRecalled
                });
            }
            
            let contentHtml = '';
            
            
            // Check if message is recalled
            if (message.isRecalled) {
                // Show different recalled message based on type
                if (message.type === 'Image') {
                    contentHtml = `<div class="teams-message-bubble recalled-message">
                        <i class="bi bi-image"></i> <em>Image has been recalled</em>
                    </div>`;
                } else if (message.type === 'File') {
                    contentHtml = `<div class="teams-message-bubble recalled-message">
                        <i class="bi bi-file-earmark"></i> <em>File has been recalled</em>
                    </div>`;
                } else {
                    contentHtml = `<div class="teams-message-bubble recalled-message">
                        <i class="bi bi-ban"></i> <em>Message has been recalled</em>
                    </div>`;
                }
            } else {
                switch (message.type) {
                    case 'Text':
                    case 'Icon':
                        contentHtml = `<div class="teams-message-bubble ${isOwn ? 'own' : ''}">${TeamsUI.escapeHtml(message.content)}</div>`;
                        break;
                case 'Image':
                    if (message.fileId) {
                        contentHtml = `
                            <div class="teams-message-bubble ${isOwn ? 'own' : ''}">
                                <img src="/files/${message.fileId}/preview" 
                                     class="teams-image-preview" 
                                     onclick="openImageModal('/files/${message.fileId}/preview')"
                                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23ddd%22 width=%22200%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2218%22 text-anchor=%22middle%22 dy=%22.3em%22%3EImage not found%3C/text%3E%3C/svg%3E';"
                                     alt="${TeamsUI.escapeHtml(message.fileName || message.content)}">
                            </div>
                        `;
                    } else {
                        contentHtml = `<div class="teams-message-bubble ${isOwn ? 'own' : ''}">
                            <em>⚠️ Image missing (fileId: ${message.fileId})</em>
                        </div>`;
                    }
                    break;
                case 'File':
                    if (message.fileId) {
                        // Xác định icon dựa trên file extension
                        const fileName = message.fileName || message.content;
                        const ext = fileName.split('.').pop().toLowerCase();
                        let fileIcon = 'bi-file-earmark';
                        let iconColor = 'var(--teams-text-secondary)';
                        
                        // File type specific icons
                        if (['pdf'].includes(ext)) {
                            fileIcon = 'bi-file-pdf';
                            iconColor = '#EF4444';
                        } else if (['doc', 'docx', 'txt'].includes(ext)) {
                            fileIcon = 'bi-file-text';
                            iconColor = '#3B82F6';
                        } else if (['xls', 'xlsx', 'csv'].includes(ext)) {
                            fileIcon = 'bi-file-earmark-spreadsheet';
                            iconColor = '#22C55E';
                        } else if (['ppt', 'pptx'].includes(ext)) {
                            fileIcon = 'bi-file-earmark-presentation';
                            iconColor = '#F59E0B';
                        } else if (['zip', 'rar', '7z'].includes(ext)) {
                            fileIcon = 'bi-file-zip';
                            iconColor = '#A855F7';
                        } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
                            fileIcon = 'bi-file-earmark-music';
                            iconColor = '#06B6D4';
                        } else if (['mp4', 'avi', 'mov'].includes(ext)) {
                            fileIcon = 'bi-file-earmark-play';
                            iconColor = '#EC4899';
                        } else if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
                            fileIcon = 'bi-file-earmark-image';
                            iconColor = '#8B5CF6';
                        }
                        
                        contentHtml = `
                            <div class="teams-file-attachment" onclick="window.open('/files/${message.fileId}', '_blank')">
                                <div class="teams-file-icon" style="color: ${iconColor};">
                                    <i class="bi ${fileIcon}"></i>
                                </div>
                                <div class="teams-file-info">
                                    <div class="teams-file-name">${TeamsUI.escapeHtml(fileName)}</div>
                                    <div class="teams-file-size">${TeamsUI.formatFileSize(message.fileSize)}</div>
                                    <div class="teams-file-extension">.${ext}</div>
                                </div>
                                <div class="teams-file-action">
                                    <i class="bi bi-download"></i>
                                </div>
                            </div>
                        `;
                    } else {
                        contentHtml = `<div class="teams-message-bubble ${isOwn ? 'own' : ''}">
                            <em><i class="bi bi-exclamation-circle me-1"></i>File missing</em>
                        </div>`;
                    }
                    break;
                }
            }

            const messageId = message.id;
            const messageSender = message.sender;
            const textContent = message.type === 'Text' && !message.isRecalled ? message.content : '';
            const recalledClass = message.isRecalled ? 'recalled' : '';

            const messageHtml = isOwn ? `
                <div class="teams-message-group own ${recalledClass}" data-message-id="${messageId}" oncontextmenu="showContextMenu(event, ${messageId}, '${TeamsUI.escapeHtml(messageSender)}', '${TeamsUI.escapeHtml(textContent).replace(/'/g, "\\'")}')">
                    <div class="teams-message-content-wrapper">
                        <div class="teams-message-header">
                            <span class="teams-message-time">${TeamsUI.formatTime(message.sentAt)}</span>
                            <span class="teams-message-sender">You</span>
                        </div>
                        ${contentHtml}
                    </div>
                    <div class="teams-message-avatar" style="background: ${avatarColor};">
                        ${avatarInitial}
                    </div>
                </div>
            ` : `
                <div class="teams-message-group ${recalledClass}" data-message-id="${messageId}" oncontextmenu="showContextMenu(event, ${messageId}, '${TeamsUI.escapeHtml(messageSender)}', '${TeamsUI.escapeHtml(textContent).replace(/'/g, "\\'")}')">
                    <div class="teams-message-avatar" style="background: ${avatarColor};">
                        ${avatarInitial}
                    </div>
                    <div class="teams-message-content-wrapper">
                        <div class="teams-message-header">
                            <span class="teams-message-sender">${TeamsUI.escapeHtml(message.sender)}</span>
                            <span class="teams-message-time">${TeamsUI.formatTime(message.sentAt)}</span>
                        </div>
                        ${contentHtml}
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();
        }


        function addSystemMessage(text) {
            const container = document.getElementById('messagesContainer');
            
            // Xác định loại icon dựa trên nội dung
            let icon = 'bi-info-circle';
            let color = 'var(--teams-status-info)';
            
            if (text.toLowerCase().includes('joined')) {
                icon = 'bi-person-plus';
                color = 'var(--teams-status-success)';
            } else if (text.toLowerCase().includes('left')) {
                icon = 'bi-person-dash';
                color = 'var(--teams-status-warning)';
            } else if (text.toLowerCase().includes('recall')) {
                icon = 'bi-arrow-clockwise';
                color = 'var(--teams-status-error)';
            } else if (text.toLowerCase().includes('uploading') || text.toLowerCase().includes('upload')) {
                icon = 'bi-cloud-upload';
                color = 'var(--teams-brand-primary)';
            } else if (text.toLowerCase().includes('connect')) {
                icon = 'bi-link-45deg';
                color = 'var(--teams-status-success)';
            } else if (text.toLowerCase().includes('error') || text.toLowerCase().includes('failed')) {
                icon = 'bi-exclamation-circle';
                color = 'var(--teams-status-error)';
            }
            
            container.insertAdjacentHTML('beforeend', `
                <div class="teams-system-message">
                    <i class="bi ${icon}" style="color: ${color}; margin-right: 8px;"></i>
                    ${TeamsUI.escapeHtml(text)}
                </div>
            `);
            scrollToBottom();
        }

        // Typing indicator functions
        function handleTyping() {
            const messageInput = document.getElementById('messageInput');
            
            if (messageInput.value.trim().length > 0) {
                if (!isTyping) {
                    isTyping = true;
                    if (connection) {
                        connection.invoke("StartTyping", roomId, username).catch(() => {});
                    }
                }
                
                // Reset timeout
                if (typingTimeout) {
                    clearTimeout(typingTimeout);
                }
                
                // Stop typing after 2 seconds of inactivity
                typingTimeout = setTimeout(() => {
                    stopTyping();
                }, 2000);
            } else {
                stopTyping();
            }
        }

        function stopTyping() {
            if (isTyping) {
                isTyping = false;
                if (connection) {
                    connection.invoke("StopTyping", roomId, username).catch(() => {});
                }
            }
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }
        }

        function updateTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            const typingText = document.getElementById('typingText');
            
            if (typingUsers.size === 0) {
                indicator.style.display = 'none';
            } else {
                indicator.style.display = 'block';
                
                const usersArray = Array.from(typingUsers);
                let text = '';
                
                if (usersArray.length === 1) {
                    text = `${usersArray[0]} is typing...`;
                } else if (usersArray.length === 2) {
                    text = `${usersArray[0]} and ${usersArray[1]} are typing...`;
                } else if (usersArray.length === 3) {
                    text = `${usersArray[0]}, ${usersArray[1]} and ${usersArray[2]} are typing...`;
                } else {
                    text = `${usersArray[0]}, ${usersArray[1]} and ${usersArray.length - 2} others are typing...`;
                }
                
                typingText.textContent = text;
            }
        }


        function updateRoomInfo(name, createdBy) {
            // Update room name displays
            document.getElementById('currentRoomName').textContent = name;
            document.getElementById('headerRoomName').textContent = name;
            
            // Update avatar initials
            const initial = name.charAt(0).toUpperCase();
            document.getElementById('roomAvatarInitial').textContent = initial;
            document.getElementById('headerAvatarInitial').textContent = initial;
            
            // Update avatar color
            const avatarColor = TeamsUI.getAvatarColor(name);
            document.getElementById('roomAvatar').style.background = avatarColor;
            document.querySelector('.teams-chat-header .teams-avatar').style.background = avatarColor;
            
            // Show delete button if user is the creator
            if (createdBy && username && createdBy.toLowerCase() === username.toLowerCase()) {
                document.getElementById('deleteRoomBtn').classList.remove('d-none');
            }
        }

        function updateUsersList(users) {
            document.getElementById('roomUserCount').textContent = `${users.length} user${users.length !== 1 ? 's' : ''} online`;
        }


        function showRoomInfo() {
            const creatorText = roomCreatedBy ? `\nCreated by: ${roomCreatedBy}` : '';
            
            // Copy Room ID to clipboard
            navigator.clipboard.writeText(roomId).then(() => {
                showToast('Room ID copied to clipboard!', 'success');
            });
            
            // Show modal-like info
            const infoDiv = document.createElement('div');
            infoDiv.className = 'room-info-popup';
            infoDiv.innerHTML = `
                <div class="room-info-overlay" onclick="this.parentElement.remove()"></div>
                <div class="room-info-content">
                    <h3>${TeamsUI.escapeHtml(roomName)}</h3>
                    <p><strong>Room ID:</strong> ${roomId}</p>
                    ${creatorText ? `<p><strong>Created by:</strong> ${TeamsUI.escapeHtml(roomCreatedBy)}</p>` : ''}
                    <p class="room-info-hint">Room ID copied! Share it with others to join.</p>
                    <button onclick="this.parentElement.parentElement.remove()">Close</button>
                </div>
            `;
            document.body.appendChild(infoDiv);
        }

        function deleteRoom() {
            // Show custom modal
            document.getElementById('deleteRoomNameDisplay').textContent = roomName;
            document.getElementById('deleteConfirmationModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteConfirmationModal').classList.remove('show');
        }

        async function confirmDeleteRoom() {
            const btn = document.getElementById('confirmDeleteBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-arrow-repeat spin me-1"></i> Deleting...';
            
            try {
                const response = await fetch(`/api/rooms/${roomId}?username=${encodeURIComponent(username)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Notify all users in the room
                    if (connection) {
                        await connection.invoke("NotifyRoomDeleted", roomId);
                    }
                    closeDeleteModal();
                    showToast('Room deleted successfully!', 'success');
                    setTimeout(() => window.location.href = '/', 1500);
                } else {
                    const error = await response.text();
                    showToast('Failed to delete room: ' + error, 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-trash me-1"></i> Delete Room';
                }
            } catch (err) {
                console.error('Delete error:', err);
                showToast('Failed to delete room', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-trash me-1"></i> Delete Room';
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !connection) return;

            // Stop typing indicator when sending
            stopTyping();

            try {
                await connection.invoke("SendMessage", roomId, username, content, "Text");
                input.value = '';
            } catch (err) {
                console.error('Send error:', err);
                showToast('Failed to send message', 'error');
            }
        }


        function toggleEmojiPicker() {
            document.getElementById('emojiPicker').classList.toggle('show');
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
            document.getElementById('emojiPicker').classList.remove('show');
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const isImage = file.type.startsWith('image/');
            const messageType = isImage ? 'Image' : 'File';

            await uploadFile(file, messageType);
            event.target.value = '';
        }

        async function uploadFile(file, messageType) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const uploadFileName = document.getElementById('uploadFileName');
            const uploadStatus = document.getElementById('uploadStatus');

            progressDiv.classList.add('show');
            uploadFileName.textContent = file.name;
            progressBar.style.width = '0%';
            uploadStatus.textContent = 'Initializing...';

            try {
                const initResponse = await fetch('/api/fileupload/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fileName: file.name,
                        totalSize: file.size,
                        contentType: file.type || 'application/octet-stream'
                    })
                });

                const { sessionId } = await initResponse.json();
                uploadStatus.textContent = 'Uploading...';

                const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
                
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, file.size);
                    const chunk = file.slice(start, end);

                    // Retry logic for chunk upload
                    let chunkUploaded = false;
                    for (let retry = 0; retry < 3; retry++) {
                        try {
                            const chunkResponse = await fetch(`/api/fileupload/chunk/${sessionId}?chunkIndex=${i}`, {
                                method: 'POST',
                                body: chunk,
                                signal: AbortSignal.timeout(60000) // 60 second timeout per chunk
                            });

                            if (!chunkResponse.ok) {
                                throw new Error(`Chunk upload failed with status ${chunkResponse.status}`);
                            }

                            const { progress } = await chunkResponse.json();
                            progressBar.style.width = `${progress}%`;
                            uploadStatus.textContent = `Uploading... ${progress}% (${i + 1}/${totalChunks} chunks)`;
                            
                            if (connection) {
                                await connection.invoke("NotifyFileUploadProgress", roomId, username, file.name, progress);
                            }

                            chunkUploaded = true;
                            break; // Success, exit retry loop
                        } catch (err) {
                            console.error(`Chunk ${i} upload attempt ${retry + 1} failed:`, err);
                            if (retry === 2) {
                                throw new Error(`Failed to upload chunk ${i} after 3 attempts`);
                            }
                            await new Promise(resolve => setTimeout(resolve, 1000 * (retry + 1))); // Exponential backoff
                        }
                    }

                    if (!chunkUploaded) {
                        throw new Error(`Could not upload chunk ${i}`);
                    }
                }

                uploadStatus.textContent = 'Finalizing...';
                const completeResponse = await fetch(`/api/fileupload/complete/${sessionId}`, {
                    method: 'POST',
                    signal: AbortSignal.timeout(120000) // 2 minute timeout for finalization
                });

                if (!completeResponse.ok) {
                    throw new Error('Failed to complete upload');
                }

                const { fileId } = await completeResponse.json();
                await connection.invoke("SendFileMessage", roomId, username, fileId, messageType);

                progressBar.style.width = '100%';
                uploadStatus.textContent = 'Complete!';

                setTimeout(() => {
                    progressDiv.classList.remove('show');
                }, 2000);

            } catch (error) {
                console.error('Upload error:', error);
                uploadStatus.textContent = `Upload failed: ${error.message || 'Unknown error'}`;
                progressBar.style.width = '0%';
                showToast('File upload failed. Please try again.', 'error');
                setTimeout(() => {
                    progressDiv.classList.remove('show');
                }, 5000);
            }
        }

        function cancelUpload() {
            document.getElementById('uploadProgress').classList.remove('show');
        }

        function openImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').style.display = 'block';
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        function leaveRoom() {
            // Show confirmation modal
            document.getElementById('leaveRoomNameDisplay').textContent = roomName;
            document.getElementById('leaveConfirmationModal').classList.add('show');
        }

        function closeLeaveModal() {
            document.getElementById('leaveConfirmationModal').classList.remove('show');
        }

        async function confirmLeaveRoom() {
            const btn = document.getElementById('confirmLeaveBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-arrow-repeat spin me-1"></i> Leaving...';
            
            try {
                if (connection) {
                    await connection.invoke("LeaveRoom", roomId, username);
                    await connection.stop();
                }
                window.location.href = '/';
            } catch (err) {
                console.error('Leave error:', err);
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-box-arrow-right me-1"></i> Leave Room';
                showToast('Failed to leave room', 'error');
            }
        }

        // Username exists modal functions
        function closeUsernameExistsModal() {
            document.getElementById('usernameExistsModal').classList.remove('show');
            window.location.href = '/';
        }

        async function retryJoinWithNewUsername() {
            const newUsernameInput = document.getElementById('newUsernameInput');
            const newName = newUsernameInput.value.trim();
            
            if (!newName) {
                newUsernameInput.style.borderColor = 'var(--teams-status-error)';
                showToast('Please enter a username', 'error');
                return;
            }
            
            username = newName;
            document.getElementById('usernameExistsModal').classList.remove('show');
            
            try {
                await connection.invoke("JoinRoom", roomId, username);
            } catch (err) {
                console.error('Join error:', err);
                showToast('Failed to join room', 'error');
            }
        }


        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        // Context Menu Functions
        function showContextMenu(e, messageId, sender, content) {
            e.preventDefault();
            
            selectedMessageId = messageId;
            selectedMessageSender = sender;
            selectedMessageContent = content;
            
            const menu = document.getElementById('contextMenu');
            const recallOption = menu.querySelector('.context-menu-recall');
            
            // Show recall option only for own messages
            if (sender === username) {
                recallOption.style.display = 'flex';
            } else {
                recallOption.style.display = 'none';
            }
            
            // Position menu
            menu.style.display = 'block';
            
            const x = e.clientX;
            const y = e.clientY;
            
            // Adjust position if menu goes off screen
            const menuRect = menu.getBoundingClientRect();
            const finalX = x + menuRect.width > window.innerWidth ? window.innerWidth - menuRect.width - 10 : x;
            const finalY = y + menuRect.height > window.innerHeight ? window.innerHeight - menuRect.height - 10 : y;
            
            menu.style.left = finalX + 'px';
            menu.style.top = finalY + 'px';
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }

        async function copyMessage() {
            hideContextMenu();
            
            if (selectedMessageContent) {
                try {
                    await navigator.clipboard.writeText(selectedMessageContent);
                    showToast('Message copied!', 'success');
                } catch (err) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = selectedMessageContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('Message copied!', 'success');
                }
            }
        }

        async function recallMessage() {
            hideContextMenu();
            
            if (!selectedMessageId || selectedMessageSender !== username) {
                showToast('You can only recall your own messages', 'error');
                return;
            }

            try {
                await connection.invoke("RecallMessage", roomId, selectedMessageId, username);
                showToast('Message recalled', 'success');
            } catch (err) {
                console.error('Recall error:', err);
                showToast('Failed to recall message', 'error');
            }
        }

        function selectMessage() {
            hideContextMenu();
            
            if (selectedMessageContent) {
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = selectedMessageContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('Message selected and copied!', 'success');
                } catch (err) {
                    console.error('Select error:', err);
                    showToast('Failed to select message', 'error');
                }
            }
        }


        // Toast Function
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'bi-check-circle-fill',
                error: 'bi-x-circle-fill',
                warning: 'bi-exclamation-triangle-fill',
                info: 'bi-info-circle-fill'
            };
            
            toast.innerHTML = `<i class="bi ${icons[type] || icons.info}"></i><span>${TeamsUI.escapeHtml(message)}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.querySelector('.teams-chat-list-panel');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                if (overlay) overlay.classList.remove('show');
            } else {
                sidebar.classList.add('show');
                if (overlay) overlay.classList.add('show');
            }
        }

        // Close sidebar when clicking overlay
        document.addEventListener('DOMContentLoaded', function() {
            // Create overlay if not exists
            if (!document.querySelector('.sidebar-overlay')) {
                const overlay = document.createElement('div');
                overlay.className = 'sidebar-overlay';
                overlay.onclick = toggleSidebar;
                document.body.appendChild(overlay);
            }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            const sidebar = document.querySelector('.teams-chat-list-panel');
            const overlay = document.querySelector('.sidebar-overlay');
            
            // If window is large enough, hide overlay and reset sidebar
            if (window.innerWidth >= 768) {
                sidebar.classList.remove('show');
                if (overlay) overlay.classList.remove('show');
            }
        });

        window.addEventListener('beforeunload', function() {
            if (connection) {
                connection.invoke("LeaveRoom", roomId, username);
            }
        });
    </script>
</body>
</html>
